<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Kakao Map Route</title>

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=18daa2632f3904b11cea2f0610fd6198&libraries=services"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #container { display: flex; height: 100vh; }
    #sidebar {
      width: 320px;
      padding: 16px;
      background: #fafafa;
      border-right: 1px solid #ddd;
    }
    #map { flex: 1; }
    input, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    button {
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    .result {
      margin-top: 12px;
      padding: 10px;
      background: #fff;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>

<div id="container">
  <div id="sidebar">
    <h3>경로 계산</h3>

    <input id="startInput" placeholder="출발지 (예: 서울역)">
    <input id="endInput" placeholder="도착지 (예: 강남역)">
    <button onclick="searchPlaces()">경로 계산</button>

    <div class="result">
      <div>거리: <span id="distance">-</span></div>
      <div>예상 시간: <span id="time">-</span></div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script>
  /* 지도 생성 */
  const map = new kakao.maps.Map(document.getElementById("map"), {
    center: new kakao.maps.LatLng(37.5665, 126.9780),
    level: 5
  });

  const ps = new kakao.maps.services.Places();

  let startMarker = null;
  let endMarker = null;
  let polyline = null;

  let startPos, endPos;

  /* 장소 검색 */
  function searchPlaces() {
    const start = document.getElementById("startInput").value;
    const end = document.getElementById("endInput").value;

    if (!start || !end) {
      alert("출발지와 도착지를 입력하세요");
      return;
    }

    ps.keywordSearch(start, (data, status) => {
      if (status !== kakao.maps.services.Status.OK) {
        alert("출발지 검색 실패");
        return;
      }

      startPos = new kakao.maps.LatLng(data[0].y, data[0].x);

      if (startMarker) startMarker.setMap(null);
      startMarker = new kakao.maps.Marker({ position: startPos, map });

      ps.keywordSearch(end, (data2, status2) => {
        if (status2 !== kakao.maps.services.Status.OK) {
          alert("도착지 검색 실패");
          return;
        }

        endPos = new kakao.maps.LatLng(data2[0].y, data2[0].x);

        if (endMarker) endMarker.setMap(null);
        endMarker = new kakao.maps.Marker({ position: endPos, map });

        requestRoute();
      });
    });
  }

  /* 서버에 경로 요청 */
  function requestRoute() {
    fetch(`/api/route?startLat=${startPos.getLat()}&startLng=${startPos.getLng()}&endLat=${endPos.getLat()}&endLng=${endPos.getLng()}`)
            .then(res => res.json())
            .then(data => drawRoute(data));
  }

  /* 경로 그리기 */
  function drawRoute(data) {
    if (polyline) polyline.setMap(null);

    const summary = data.routes[0].summary;
    const roads = data.routes[0].sections[0].roads;

    document.getElementById("distance").innerText =
            (summary.distance / 1000).toFixed(2) + " km";
    document.getElementById("time").innerText =
            Math.round(summary.duration / 60) + " 분";

    const path = [];

    roads.forEach(road => {
      const vertexes = road.vertexes;
      for (let i = 0; i < vertexes.length; i += 2) {
        path.push(new kakao.maps.LatLng(vertexes[i + 1], vertexes[i]));
      }
    });

    polyline = new kakao.maps.Polyline({
      path,
      strokeWeight: 5,
      strokeColor: '#ff0000',
      strokeOpacity: 0.9,
      strokeStyle: 'solid'
    });

    polyline.setMap(map);

    const bounds = new kakao.maps.LatLngBounds();
    path.forEach(p => bounds.extend(p));
    map.setBounds(bounds);
  }
</script>

</body>
</html>
