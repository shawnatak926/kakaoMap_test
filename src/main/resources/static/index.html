<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Kakao Map Route + GPS</title>

  <!-- Kakao Map SDK -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=18daa2632f3904b11cea2f0610fd6198&libraries=services"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #container {
      display: flex;
      height: 100vh;
    }

    #sidebar {
      width: 320px;
      padding: 16px;
      background: #fafafa;
      border-right: 1px solid #ddd;
      box-sizing: border-box;
    }

    #map {
      flex: 1;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 14px;
      border: none;
      cursor: pointer;
      border-radius: 6px;
    }

    /* Í≤ΩÎ°ú Í≥ÑÏÇ∞ Î≤ÑÌäº */
    #routeBtn {
      background-color: #5366FB;
      color: white;
      font-weight: bold;
    }

    #routeBtn:hover {
      opacity: 0.9;
    }

    /* GPS Î≤ÑÌäº */
    #gpsBtn {
      background: #eaeaea;
    }

    .result {
      margin-top: 12px;
      padding: 10px;
      background: #fff;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>

<div id="container">
  <div id="sidebar">
    <h3>Í≤ΩÎ°ú Í≥ÑÏÇ∞</h3>

    <input id="startInput" placeholder="Ï∂úÎ∞úÏßÄ (Ïòà: ÏÑúÏö∏Ïó≠)">
    <button id="gpsBtn" onclick="useMyLocation()">üìç ÎÇ¥ ÏúÑÏπòÎ•º Ï∂úÎ∞úÏßÄÎ°ú</button>

    <input id="endInput" placeholder="ÎèÑÏ∞©ÏßÄ (Ïòà: Í∞ïÎÇ®Ïó≠)">
    <button id="routeBtn" onclick="searchPlaces()">Í≤ΩÎ°ú Í≥ÑÏÇ∞</button>

    <div class="result">
      <div>Í±∞Î¶¨: <span id="distance">-</span></div>
      <div>ÏòàÏÉÅ ÏãúÍ∞Ñ: <span id="time">-</span></div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script>
  /* ÏßÄÎèÑ ÏÉùÏÑ± */
  const map = new kakao.maps.Map(document.getElementById("map"), {
    center: new kakao.maps.LatLng(37.5665, 126.9780),
    level: 5
  });

  const ps = new kakao.maps.services.Places();

  let startMarker = null;
  let endMarker = null;
  let polyline = null;

  let startPos = null;
  let endPos = null;

  /* GPSÎ°ú ÌòÑÏû¨ ÏúÑÏπò */
  function useMyLocation() {
    if (!navigator.geolocation) {
      alert("GPSÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Î∏åÎùºÏö∞Ï†ÄÏûÖÎãàÎã§.");
      return;
    }

    navigator.geolocation.getCurrentPosition(
            position => {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;

              startPos = new kakao.maps.LatLng(lat, lng);

              if (startMarker) startMarker.setMap(null);
              startMarker = new kakao.maps.Marker({
                position: startPos,
                map: map
              });

              map.setCenter(startPos);
              document.getElementById("startInput").value = "ÎÇ¥ ÏúÑÏπò";
            },
            () => {
              alert("ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.");
            }
    );
  }

  /* Ïû•ÏÜå Í≤ÄÏÉâ */
  function searchPlaces() {
    const start = document.getElementById("startInput").value;
    const end = document.getElementById("endInput").value;

    if (!startPos && !start) {
      alert("Ï∂úÎ∞úÏßÄÎ•º ÏûÖÎ†•ÌïòÍ±∞ÎÇò GPSÎ•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.");
      return;
    }

    if (!end) {
      alert("ÎèÑÏ∞©ÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
      return;
    }

    if (!startPos) {
      ps.keywordSearch(start, (data, status) => {
        if (status !== kakao.maps.services.Status.OK) {
          alert("Ï∂úÎ∞úÏßÄ Í≤ÄÏÉâ Ïã§Ìå®");
          return;
        }
        startPos = new kakao.maps.LatLng(data[0].y, data[0].x);
        if (startMarker) startMarker.setMap(null);
        startMarker = new kakao.maps.Marker({ position: startPos, map });
        searchEnd();
      });
    } else {
      searchEnd();
    }
  }

  function searchEnd() {
    const end = document.getElementById("endInput").value;

    ps.keywordSearch(end, (data, status) => {
      if (status !== kakao.maps.services.Status.OK) {
        alert("ÎèÑÏ∞©ÏßÄ Í≤ÄÏÉâ Ïã§Ìå®");
        return;
      }

      endPos = new kakao.maps.LatLng(data[0].y, data[0].x);

      if (endMarker) endMarker.setMap(null);
      endMarker = new kakao.maps.Marker({ position: endPos, map });

      requestRoute();
    });
  }

  /* ÏÑúÎ≤ÑÏóê Í≤ΩÎ°ú ÏöîÏ≤≠ */
  function requestRoute() {
    fetch(`/api/route?startLat=${startPos.getLat()}&startLng=${startPos.getLng()}&endLat=${endPos.getLat()}&endLng=${endPos.getLng()}`)
            .then(res => res.json())
            .then(data => drawRoute(data));
  }

  /* Í≤ΩÎ°ú Í∑∏Î¶¨Í∏∞ */
  function drawRoute(data) {
    if (polyline) polyline.setMap(null);

    const summary = data.routes[0].summary;
    const roads = data.routes[0].sections[0].roads;

    document.getElementById("distance").innerText =
            (summary.distance / 1000).toFixed(2) + " km";
    document.getElementById("time").innerText =
            Math.round(summary.duration / 60) + " Î∂Ñ";

    const path = [];

    roads.forEach(road => {
      const v = road.vertexes;
      for (let i = 0; i < v.length; i += 2) {
        path.push(new kakao.maps.LatLng(v[i + 1], v[i]));
      }
    });

    polyline = new kakao.maps.Polyline({
      path,
      strokeWeight: 5,
      strokeColor: "#ff0000",
      strokeOpacity: 0.9
    });

    polyline.setMap(map);

    const bounds = new kakao.maps.LatLngBounds();
    path.forEach(p => bounds.extend(p));
    map.setBounds(bounds);
  }
</script>

</body>
</html>
