<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Kakao Map Route + GPS</title>

  <!-- Kakao Map SDK -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=18daa2632f3904b11cea2f0610fd6198&libraries=services"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #container {
      display: flex;
      height: 100vh;
    }

    #sidebar {
      width: 320px;
      padding: 16px;
      background: #fafafa;
      border-right: 1px solid #ddd;
      box-sizing: border-box;
    }

    #map {
      flex: 1;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 14px;
      border: none;
      cursor: pointer;
      border-radius: 6px;
    }

    #routeBtn {
      background-color: #5366FB;
      color: white;
      font-weight: bold;
    }

    #gpsBtn {
      background: #eaeaea;
    }

    .destBtn {
      background: #ffffff;
      border: 1px solid #ddd;
    }

    .result {
      margin-top: 12px;
      padding: 10px;
      background: #fff;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>

<div id="container">
  <div id="sidebar">
    <h3>ê²½ë¡œ ê³„ì‚°</h3>

    <input id="startInput" placeholder="ì¶œë°œì§€ (ì˜ˆ: ì„œìš¸ì—­)">
    <button id="gpsBtn" onclick="useMyLocation()">ğŸ“ ë‚´ ìœ„ì¹˜ë¥¼ ì¶œë°œì§€ë¡œ</button>

    <input id="endInput" placeholder="ë„ì°©ì§€" readonly>

    <!-- ê³ ì • ë„ì°©ì§€ ë²„íŠ¼ -->
    <button class="destBtn" onclick="selectFixedDestination('ë™ëŒ€êµ¬ì—­')">ë™ëŒ€êµ¬ì—­</button>
    <button class="destBtn" onclick="selectFixedDestination('ìš©ì‚°ì—­')">ìš©ì‚°ì—­</button>
    <button class="destBtn" onclick="selectFixedDestination('ëŒ€ê³¡ì—­')">ëŒ€ê³¡ì—­</button>

    <button id="routeBtn" onclick="searchPlaces()">ê²½ë¡œ ê³„ì‚°</button>

    <div class="result">
      <div>ê±°ë¦¬: <span id="distance">-</span></div>
      <div>ì˜ˆìƒ ì‹œê°„: <span id="time">-</span></div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script>
  /* ì‹¤ì œ ê²€ìƒ‰ìš© ë„ì°©ì§€ ë§¤í•‘ */
  const DEST_MAP = {
    "ë™ëŒ€êµ¬ì—­": "ë™ëŒ€êµ¬ì—­ 1í˜¸ì„ ",
    "ìš©ì‚°ì—­": "ìš©ì‚°ì—­ 2í˜¸ì„ ",
    "ëŒ€ê³¡ì—­": "ëŒ€ê³¡ì—­ 1í˜¸ì„ "
  };

  const map = new kakao.maps.Map(document.getElementById("map"), {
    center: new kakao.maps.LatLng(37.5665, 126.9780),
    level: 5
  });

  const ps = new kakao.maps.services.Places();

  let startMarker = null;
  let endMarker = null;
  let polyline = null;

  let startPos = null;
  let endPos = null;

  /* GPS ì¶œë°œì§€ */
  function useMyLocation() {
    navigator.geolocation.getCurrentPosition(pos => {
      startPos = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);

      if (startMarker) startMarker.setMap(null);
      startMarker = new kakao.maps.Marker({ position: startPos, map });

      map.setCenter(startPos);
      document.getElementById("startInput").value = "ë‚´ ìœ„ì¹˜";
    });
  }

  /* ê³ ì • ë„ì°©ì§€ ì„ íƒ + ìë™ ê²½ë¡œ ê³„ì‚° */
  function selectFixedDestination(label) {
    const keyword = DEST_MAP[label];

    document.getElementById("endInput").value = keyword;
    endPos = null;

    ps.keywordSearch(keyword, (data, status) => {
      if (status !== kakao.maps.services.Status.OK) {
        alert("ë„ì°©ì§€ ê²€ìƒ‰ ì‹¤íŒ¨");
        return;
      }

      endPos = new kakao.maps.LatLng(data[0].y, data[0].x);

      if (endMarker) endMarker.setMap(null);
      endMarker = new kakao.maps.Marker({ position: endPos, map });

      map.setCenter(endPos);

      searchPlaces(); // ìë™ ê²½ë¡œ ê³„ì‚°
    });
  }

  /* ì¶œë°œì§€ / ë„ì°©ì§€ ê²€ìƒ‰ */
  function searchPlaces() {
    const start = document.getElementById("startInput").value;

    if (!startPos && !start) {
      alert("ì¶œë°œì§€ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ GPSë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.");
      return;
    }

    if (!endPos) {
      alert("ë„ì°©ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }

    if (!startPos) {
      ps.keywordSearch(start, (data, status) => {
        if (status !== kakao.maps.services.Status.OK) {
          alert("ì¶œë°œì§€ ê²€ìƒ‰ ì‹¤íŒ¨");
          return;
        }

        startPos = new kakao.maps.LatLng(data[0].y, data[0].x);

        if (startMarker) startMarker.setMap(null);
        startMarker = new kakao.maps.Marker({ position: startPos, map });

        requestRoute();
      });
    } else {
      requestRoute();
    }
  }

  /* ì„œë²„ì— ê²½ë¡œ ìš”ì²­ */
  function requestRoute() {
    fetch(`/api/route?startLat=${startPos.getLat()}&startLng=${startPos.getLng()}&endLat=${endPos.getLat()}&endLng=${endPos.getLng()}`)
            .then(res => res.json())
            .then(drawRoute);
  }

  /* ê²½ë¡œ í‘œì‹œ */
  function drawRoute(data) {
    if (polyline) polyline.setMap(null);

    const summary = data.routes[0].summary;
    const roads = data.routes[0].sections[0].roads;

    document.getElementById("distance").innerText =
            (summary.distance / 1000).toFixed(2) + " km";
    document.getElementById("time").innerText =
            Math.round(summary.duration / 60) + " ë¶„";

    const path = [];
    roads.forEach(r => {
      for (let i = 0; i < r.vertexes.length; i += 2) {
        path.push(new kakao.maps.LatLng(r.vertexes[i + 1], r.vertexes[i]));
      }
    });

    polyline = new kakao.maps.Polyline({
      path,
      strokeWeight: 5,
      strokeColor: "#ff0000",
      strokeOpacity: 0.9
    });

    polyline.setMap(map);

    const bounds = new kakao.maps.LatLngBounds();
    path.forEach(p => bounds.extend(p));
    map.setBounds(bounds);
  }
</script>

</body>
</html>
